@page "/Group/{podId:guid}/Decks"
@using EdhTracker.Components
@using EdhTracker.Data
@using Microsoft.EntityFrameworkCore
@using Org.OpenAPITools.Api
@using System.ComponentModel.DataAnnotations
@using Serilog
@inject IDialogService DialogService

<PageTitle>@Pod.Name Decks</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">@Pod.Name Decks</MudText>

<MudButton Color="Color.Primary" OnClick="OpenAddDeckDialog">Add Deck</MudButton>

<MudPaper Class="pa-4">
    <MudGrid>
        @foreach (var deck in Pod.Decks)
        {
            <MudItem xs="3">
                <DeckCard Deck="deck"></DeckCard>
            </MudItem>
        }
    </MudGrid>
</MudPaper>

@code
{
    protected override async Task OnInitializedAsync()
    {
        DataContext = await DataContextFactory.CreateDbContextAsync();
    }
    private DataContext DataContext;

    [Parameter]
    public Guid PodId { get; set; }

    [Inject]
    public IDbContextFactory<DataContext> DataContextFactory { get; set; }

    public PlayGroup Pod { get => DataContext.PlayGroups.Include(p => p.Players).Include(p => p.Decks).First(p => p.Id == PodId); }

    private async Task OpenAddDeckDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialogParams = new DialogParameters<AddDeckDialog>();
        dialogParams.Add(x => x.DataContext, DataContext);
        dialogParams.Add(x => x.Pod, Pod);

        try
        {
            var dialog = DialogService.Show<AddDeckDialog>("Add Deck", dialogParams, options);
            var result = await dialog.Result;

            if (!result.Canceled)
            {
                await DataContext.Entry(Pod).ReloadAsync();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Log.Error(ex, "Issue during add deck dialog");
            throw;
        }
    }
}
